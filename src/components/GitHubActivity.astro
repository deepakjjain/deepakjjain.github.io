---
const username = 'deepakjjain';

interface GitHubUser {
  login: string;
  name: string | null;
  bio: string | null;
  public_repos: number;
  followers: number;
  following: number;
  html_url: string;
}

interface GitHubRepo {
  name: string;
  description: string | null;
  html_url: string;
  stargazers_count: number;
  forks_count: number;
  language: string | null;
  fork: boolean;
}

let user: GitHubUser | null = null;
let repos: GitHubRepo[] = [];
let apiError = false;

try {
  const [userRes, reposRes] = await Promise.all([
    fetch(`https://api.github.com/users/${username}`, {
      headers: { 'User-Agent': 'deepakjjain-portfolio-build' },
    }),
    fetch(
      `https://api.github.com/users/${username}/repos?sort=stars&per_page=6&type=owner`,
      { headers: { 'User-Agent': 'deepakjjain-portfolio-build' } }
    ),
  ]);

  if (userRes.ok) user = (await userRes.json()) as GitHubUser;
  if (reposRes.ok) {
    const all = (await reposRes.json()) as GitHubRepo[];
    // Filter out forks, sort by stars descending, take top 6
    repos = all
      .filter((r) => !r.fork)
      .sort((a, b) => b.stargazers_count - a.stargazers_count)
      .slice(0, 6);
  }
} catch {
  apiError = true;
}

const languageColors: Record<string, string> = {
  TypeScript: 'badge-info',
  JavaScript: 'badge-warning',
  Python: 'badge-success',
  Rust: 'badge-error',
  Go: 'badge-accent',
  HTML: 'badge-secondary',
  CSS: 'badge-primary',
};
---

<section id="github" class="py-24 px-4 bg-base-200">
  <div class="max-w-5xl mx-auto">

    <h2 class="text-3xl sm:text-4xl font-bold mb-4 text-center">
      GitHub <span class="text-primary">Activity</span>
    </h2>
    <p class="text-center text-base-content/55 mb-14 text-sm">
      Data fetched at build time from the GitHub public API.
    </p>

    {apiError || !user ? (
      <!-- Fallback if API unavailable at build time -->
      <div class="text-center py-12">
        <p class="text-base-content/55 mb-6">
          GitHub profile data unavailable at build time.
        </p>
        <a
          href={`https://github.com/${username}`}
          target="_blank"
          rel="noopener noreferrer"
          class="btn btn-outline gap-2"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
          View on GitHub
        </a>
      </div>
    ) : (
      <>
        <!-- Stats row -->
        <div class="grid grid-cols-3 gap-4 max-w-sm mx-auto mb-14">
          <div class="bg-base-100 rounded-2xl p-5 text-center">
            <div class="text-3xl font-bold text-primary">{user.public_repos}</div>
            <div class="text-xs text-base-content/50 mt-1">Repos</div>
          </div>
          <div class="bg-base-100 rounded-2xl p-5 text-center">
            <div class="text-3xl font-bold text-primary">{user.followers}</div>
            <div class="text-xs text-base-content/50 mt-1">Followers</div>
          </div>
          <div class="bg-base-100 rounded-2xl p-5 text-center">
            <div class="text-3xl font-bold text-primary">{user.following}</div>
            <div class="text-xs text-base-content/50 mt-1">Following</div>
          </div>
        </div>

        <!-- Top repos grid -->
        {repos.length > 0 && (
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {repos.map((repo) => (
              <a
                href={repo.html_url}
                target="_blank"
                rel="noopener noreferrer"
                class="bg-base-100 rounded-xl p-5 flex flex-col gap-3 hover:shadow-md transition-shadow group"
              >
                <div class="flex items-start justify-between gap-2">
                  <h3 class="font-semibold text-sm group-hover:text-primary transition-colors leading-snug">
                    {repo.name}
                  </h3>
                  {repo.language && (
                    <span class={`badge badge-xs shrink-0 ${languageColors[repo.language] ?? 'badge-ghost'}`}>
                      {repo.language}
                    </span>
                  )}
                </div>
                {repo.description && (
                  <p class="text-xs text-base-content/55 leading-relaxed flex-1">
                    {repo.description.length > 80
                      ? repo.description.slice(0, 80) + '…'
                      : repo.description}
                  </p>
                )}
                <div class="flex items-center gap-4 text-xs text-base-content/40">
                  <span class="flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    {repo.stargazers_count}
                  </span>
                  <span class="flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                    </svg>
                    {repo.forks_count}
                  </span>
                </div>
              </a>
            ))}
          </div>
        )}

        <div class="text-center mt-10">
          <a
            href={user.html_url}
            target="_blank"
            rel="noopener noreferrer"
            class="btn btn-ghost btn-sm gap-2"
          >
            View all repos on GitHub →
          </a>
        </div>
      </>
    )}

  </div>
</section>
